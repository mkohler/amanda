.\"
.de EX
.if t .ft C
.nf
..
.de EE
.fi
.if t .ft
..
.de P1
\fB\\$1\fP \\$2 \fI\\$3\fP \\$4 \fI\\$5\fP \\$6 \\$7
..
.de P2
\fB\\$1\fP \fI\\$2\fP \\$3 \\$4 \\$5
..
.de P3
\fB\\$1\fP \\$2 \fI\\$3\fP \\$4 \fI\\$5\fP \\$6 \\$7
..
.TH AMADMIN 8
.SH NAME
amadmin \- administrative interface to control Amanda backups
.SH SYNOPSIS
.B amadmin
.I config
.I command
[
.I command options
]
.SH DESCRIPTION
.B Amadmin
performs various administrative tasks on the
.I config
Amanda configuration.
.LP
See the
.IR amanda (8)
man page for more details about Amanda.
.SH COMMANDS
Commands that take a
.I hostname
[
.I disks
]
parameter pair operate on all disks in the
.I disklist
for that
.I hostname
if no disks are specified.
Where
.I hostname
is also marked as being optional,
the command operates on all hosts and disks in the
.IR disklist .
Both
.I hostnames
and
.I disk
are special expression, see the "HOST & DISK EXPRESSION" section
of 
.IR amanda (8)
for a description.
.LP
.TP
.B version
Show the current version and some compile time and runtime parameters.
The
.I config
parameter must be present but is ignored.
.TP
.P1 force-bump [ hostname [ disks ]* ]+
Force the
.I disks
on
.I hostname
to bump to a new incremental level during the next Amanda run.
.TP
.P1 force-no-bump [ hostname [ disks ]* ]+
Force the
.I disks
on
.I hostname
to not bump to a new incremental level during the next Amanda run.
.TP
.P1 unforce-bump [ hostname [ disks ]* ]+
Undo a previous
.B force-bump
or
.B force-no-bump
command.
.TP
.P1 force [ hostname [ disks ]* ]+
Force the
.I disks
on
.I hostname
to do a full (level 0) backup during the next Amanda run.
.TP
.P1 unforce [ hostname [ disks ]* ]+
Undo a previous
.B force
command.
.TP
.P2 reuse tapelabel [ ... ]
The tapes listed
will be available for reuse at their point in the tape cycle.
.TP
.P2 no-reuse tapelabel [ ... ]
The tapes listed
will not be reused when their turn comes up again in the tape cycle.
Note that if this causes the number of reusable tapes to drop below the
.B amanda.conf
.I tapecycle
value, Amanda will request new tapes until the count is satisfied again.
.TP
.P1 due [ hostname [ disks ]* ]*
Show when the next full dump is due.
.TP
.P3 "find\fP [ \fB--sort\fP \fBhkdlb\fP ]\fB" [ hostname [ disks ]* ]*
Display all backups currently on tape or in the holding disk.
The tape label or holding disk filename,
file number,
and status are displayed.
.IP
The
.B --sort
option changes the sort order using the following flags:
.RS
.LP
.de SO
\fB\\$1\fP	\\$2
.br
..
.SO h "host name"
.SO k "disk name"
.SO d "dump date"
.SO l "backup level"
.SO b "tape label"
.RE
.IP
An uppercase letter reverses the sort order for that key.
The default sort order is
.BR hkdlb .
.TP
.P1 delete [ hostname [ disks ]* ]+
Delete the specified
.I disks
on
.I hostname
from the Amanda
database.
.IP
Note: if you do not also remove the disk from the
.I disklist
file, Amanda will treat it as a new disk during the next run.
.TP
.B tape
Display the tape(s) Amanda expects to write to during the next run.
See also
.IR amcheck (8).
.TP
.B bumpsize
Display the current bump threshold parameters, calculated for all backup
levels.
.TP
.P3 "balance\fP [ \fB--days\fP \fB<num>\fP ]\fB"
Display the distribution of full backups throughout the dump schedule.
.TP
.P1 export [ hostname [ disks ]* ]*
Convert records from the Amanda database
to a text format that may be transmitted to another Amanda
machine and
.BR import ed.
.TP
.B import
Convert
.BR export ed
records read from standard input to a form Amanda uses
and insert them into the database on this machine.
.TP
.P1 disklist [ hostname [ disks ]* ]*
Display the
.I disklist
information for each of the
.I disks
on
.I hostname
(or all hosts).
Mostly used for debugging.
.TP
.P1 info [ hostname [ disks ]* ]*
Display the
database record for each of the
.I disks
on
.IR hostname
(or all hosts).
Mostly used for debugging.
.SH EXAMPLES
Request three specific file systems on
.I machine-a
get a full level 0 backup during the next Amanda run.
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ force machine-a / /var /usr
amadmin: machine-a:/ is set to a forced level 0 tonight.
amadmin: machine-a:/var is set to a forced level 0 tonight.
amadmin: machine-a:/usr is set to a forced level 0 tonight.
.EE
.RE
.LP
Request all file systems on
.I machine-b
get a full level 0 backup during the next Amanda run.
.RE
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ force machine-b
amadmin: machine-b:/ is set to a forced level 0 tonight.
amadmin: machine-b:/var is set to a forced level 0 tonight.
amadmin: machine-b:/usr is set to a forced level 0 tonight.
amadmin: machine-b:/home is set to a forced level 0 tonight.
.EE
.RE
.LP
Undo the previous
.B force
request for
.I /home
on
.IR machine-b .
The other file systems will still get a full level 0 backup.
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ unforce machine-b /home
amadmin: force command for machine-b:/home cleared.
.EE
.RE
.LP
Locate backup images of
.I /var
from
.IR machine-c .
The
.I tape or file
column displays either a tape label or a filename depending on whether
the image is on tape or is still in the holding disk.
If the image is on tape, the
.I file
column tells you which file on the tape has the image
(file number zero is a tape label).
This column shows zero and is not meaningful if the image
is still in the holding disk.
The
.I status
column tells you whether the backup was successful or had
some type of error.
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ find machine-c /var
date        host      disk lv tape or file                    file status
2000-11-09  machine-c /var  0 000110                             9 OK
2000-11-08  machine-c /var  2 000109                             2 OK
2000-11-07  machine-c /var  2 /amanda/20001107/machine-c._var.2  0 OK
2000-11-06  machine-c /var  2 000107                             2 OK
2000-11-05  machine-c /var  2 000106                             3 OK
2000-11-04  machine-c /var  2 000105                             2 OK
2000-11-03  machine-c /var  2 000104                             2 OK
2000-11-02  machine-c /var  2 000103                             2 OK
2000-11-01  machine-c /var  1 000102                             5 OK
2000-10-31  machine-c /var  1 000101                             3 OK
.EE
.RE
.LP
Forget about the
.I /workspace
disk on
.IR machine-d .
If you do not also remove the disk from the
.I disklist
file, Amanda will treat it as a new disk during the next run.
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ delete machine-d /workspace
amadmin: machine-d:/workspace deleted from database.
amadmin: NOTE: you'll have to remove these from the disklist yourself.
.EE
.RE
.LP
Find the next tape Amanda will use
(in this case, 
.IR 123456 ).
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ tape
The next Amanda run should go onto tape 123456 or a new tape.
.EE
.RE
.LP
Show how well full backups are balanced across the dump cycle.
The
.I due-date
column is the day the backups are due for a full backup.
.I #fs
shows the number of filesystems doing full backups that night, and
.I orig KB
and
.I out KB
show the estimated total size of the backups
before and after any compression, respectively.
.LP
The
.I balance
column shows how far off that night's backups are from the average size
(shown at the bottom of the balance column).
Amanda tries to keep the backups within +/- 5%,
but since the amount of data on each filesystem is always changing,
and Amanda will never delay backups just to rebalance the schedule,
it is common for the schedule to fluctuate by larger percentages.
In particular,
in the case of a tape or backup failure,
a bump will occur the following night,
which will not be smoothed out until the next pass through the schedule.
.LP
The last line also shows an estimate of how many Amanda runs will be
made between full backups for a file system.
In the example, a file system will probably have a full backup done
every eight times Amanda is run (e.g. every eight days).
.LP
.RS
.EX
$ amadmin @DEFAULT_CONFIG@ balance
 due-date  #fs   orig KB    out KB  balance
-------------------------------------------
11/10 Mon   21    930389    768753    +5.1%
11/11 Tue   29   1236272    733211    +0.2%
11/12 Wed   31   1552381    735796    +0.6%
11/13 Thu   23   1368447    684552    -6.4%
11/14 Fri   32   1065603    758155    +3.6%
11/15 Sat   14   1300535    738430    +0.9%
11/16 Sun   31   1362696    740365    +1.2%
11/17 Mon   30   1427936    773397    +5.7%
11/18 Tue   11   1059191    721786    -1.3%
11/19 Wed   19   1108737    661867    -9.5%
-------------------------------------------
TOTAL      241  12412187   7316312   731631  (estimated 8 runs per dumpcycle)
.EE
.SH FILES
@CONFIG_DIR@/\fIconfig\fP/amanda.conf
.SH AUTHOR
James da Silva <jds@cs.umd.edu>
.br
University of Maryland, College Park
.SH "SEE ALSO"
amanda(8),
amcheck(8),
amdump(8),
amrestore(8)
