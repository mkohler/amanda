.\"Generated by db2man.xsl. Don't modify this, modify the source.
.de Sh \" Subsection
.br
.if t .Sp
.ne 5
.PP
\fB\\$1\fR
.PP
..
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Ip \" List item
.br
.ie \\n(.$>=3 .ne \\$3
.el .ne 3
.IP "\\$1" \\$2
..
.TH "AMCHECK" 8 "" "" ""
.SH NAME
amcheck \- run AMANDA self-checks
.SH "SYNOPSIS"
.ad l
.hy 0
.HP 8
\fBamcheck\fR [\-mwsclt] [\-Maddress] \fIconfig\fR [\fIhost\fR\ [\fIdisk\fR...]...]
.ad
.hy

.SH "DESCRIPTION"

.PP
\fBAmcheck\fR runs a number of self\-checks on both the \fBAMANDA\fR tape server host and the \fBAMANDA\fR client hosts\&.

.PP
On the tape server host, \fBamcheck\fR can go through the same tape checking used at the start of the nightly \fBamdump\fR run to verify the correct tape for the next run is mounted\&.

.PP
\fBAmcheck\fR can also do a self\-check on all client hosts to make sure each host is running and that permissions on filesystems to be backed up are correct\&.

.PP
You can specify many host/disk expressions, only disks that match an expression will be checked\&. All disks are checked if no expressions are given\&.

.PP
See the \fBamanda\fR(8) man page for more details about \fBAMANDA\fR\&.

.SH "OPTIONS"

.TP
\fB\-s\fR
Run the tape server local and tape checks (same as \fB\-lt\fR)\&.

.TP
\fB\-c\fR
Run the client host checks\&.

.TP
\fB\-l\fR
Run the local tests (e\&.g\&. permissions) on the server host\&.

.TP
\fB\-t\fR
Run the tape tests on the server host\&.

.TP
\fB\-w\fR
Enables a destructive check for write\-protection on the tape (which would otherwise cause the subsequent \fBamdump\fR to fail)\&. If the tape is writable, this check causes all data after the tape label to be erased (actually depends on the device driver: there is no portable non\-destructive way to check for write\-protection)\&. The check implies \fB\-t\fR and is only made if the tape is otherwise correct\&.

.TP
\fB\-m\fR
Nothing is printed, but mail is sent if any errors are detected\&. The mail goes to the \fBmailto\fR address specified in the \fBamanda\&.conf\fR file or the \fBaddress\fR value if \fB\-M\fR is set\&.

.TP
\fB\-a\fR
Like \fB\-m\fR but the mail is always sent\&.

.TP
\fB\-M\fR\fIaddress\fR
Mail the report to \fBaddress\fR instead of the \fBmailto\fR value from \fBamanda\&.conf\fR\&. Implies \fB\-m\fR\&.

.PP
The default is \fB\-cs\fR\&.

.SH "EXAMPLES"

.PP
In this example, both the tape server and client tests are run\&. The results are displayed on standard output\&.
.nf

% amcheck daily
\fBAMANDA\fR Tape Server Host Check
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
/amanda2/amanda/work: 911475 KB disk space available, that's plenty\&.
NOTE: skipping tape\-writable test\&.
Tape VOL10 label ok\&.
Server check took 34\&.966 seconds\&.

\fBAMANDA\fR Backup Client Hosts Check
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
WARNING: northstar: selfcheck request timed out\&.  Host down?
WARNING: drinkme: selfcheck request timed out\&.  Host down?
WARNING: scruffy: selfcheck request timed out\&.  Host down?
Client check: 136 hosts checked in 51\&.945 seconds, 3 problems found\&.

(brought to you by \fBAMANDA\fR 2\&.4\&.5) 
.fi

.PP
In this example, if the line \fBmailto csd\-amanda\fR is in \fBamanda\&.conf\fR, mail will be sent to \fBcsd\-amanda\fR if the server check returns an error\&.
.nf

% amcheck \-s \-m daily 
.fi

.SH "MESSAGES"

.TP
fatal slot \fBslot\fR: \fBerror message\fR
(error) The tape changer detected some kind of fatal error while trying to load slot \fBslot\fR\&.

.TP
slot \fBslot\fR: \fBerror message\fR
(warning) The tape changer detected some kind of non\-fatal error (e\&.g\&. an empty slot was detected) while trying to load slot \fBslot\fR, or an error was detected trying to read the tape label\&.

.TP
slot \fBslot\fR: date \fBYYYYMMDD\fR label \fBlabel\fR (\fBresult\fR)
(info) Tape \fBlabel\fR in slot \fBslot\fR was loaded and found to have been last written on \fBYYYYMMDD\fR\&. If the tape is new, the date field will be an \fBX\fR\&. The \fBresult\fR may be one of:

.RS

.TP
exact label match
This is the expected tape\&.

.TP
no match
This label does not match the \fBlabelstr\fR pattern in \fBamanda\&.conf\fR\&. Tape scanning will continue\&.

.TP
active tape
This tape is still active and cannot be overwritten\&. Tape scanning will continue\&.

.TP
first labelstr match
This tape is the first one that matches the \fBlabelstr\fR pattern in \fBamanda\&.conf\fR\&. Tape scanning will continue if necessary\&.

.TP
labelstr match
This tape is the next one that matches the \fBlabelstr\fR pattern in \fBamanda\&.conf\fR\&. Tape scanning will continue\&.

.RE
.IP

.TP
ERROR: cannot look up dump user \fBuser\fR
(error) Dump user \fBuser\fR from \fBamanda\&.conf\fR could not be found in the system password information\&.

.TP
ERROR: cannot look up my own uid (\fBuid\fR)
(error) User id \fBuid\fR running \fBamcheck\fR could not be found in the system password information\&.

.TP
ERROR: running as user \fBrunuser\fR instead of \fBdumpuser\fR
(error) \fBAmcheck\fR should be run as the dump user \fBdumpuser\fR from \fBamanda\&.conf\fR instead of \fBrunuser\fR\&.

.TP
ERROR: program dir \fBdirectory\fR: not accessible
(error) The directory \fBAMANDA\fR expects to find its auxiliary programs in, \fBdirectory\fR, is not accessible\&.

.TP
ERROR: program \fBprogram\fR: does not exist
(error) Program \fBprogram\fR needed on the tape server could not be found\&.

.TP
ERROR: program \fBprogram\fR: not a file
(error) Program \fBprogram\fR needed on the tape server exists but is not a file\&.

.TP
ERROR: program \fBprogram\fR: not executable
(error) Program \fBprogram\fR needed on the tape server exists but is not executable\&.

.TP
WARNING: program \fBprogram\fR: not setuid\-root
(warning) Program \fBprogram\fR needed on the tape server exists but should be owned by user "root" and setuid\&.

.TP
ERROR: \fBXXX\fR dir \fBdirectory\fR: not writable
(error) Directory \fBdirectory\fR is either not writable, i\&.e\&. the dump user will not be able to create or remove files, or cannot be accessed, perhaps because a parent directory does not allow search permission\&. The \fBXXX\fR may be:

.RS

.TP
log
for the \fBAMANDA\fR log directory (see \fBlogdir\fR in \fBamanda\&.conf\fR)

.TP
oldlog
for the directory that holds the old log files (see \fBlogdir\fR in \fBamanda\&.conf\fR)

.TP
info
for an \fBAMANDA\fR database information directory (see \fBcurinfo\fR in \fBamanda\&.conf\fR) or

.TP
index
for an \fBAMANDA\fR index directory (see \fBindexdir\fR in \fBamanda\&.conf\fR)

.TP
tapelist
for the \fBAMANDA\fR tapelist directory (see \fBtapelist\fR in \fBamanda\&.conf\fR)

.RE
.IP

.TP
NOTE: \fBXXX\fR dir \fBdirectory\fR: does not exist
(info) A database (info) or index directory does not exist or cannot be accessed\&. This might just mean this is a new client or disk, but if that is not the case, this should be treated as an error\&.

.TP
NOTE: it will be created on the next run
(info) This indicates the info directory listed in the previous message will be created on the next run\&.

.TP
ERROR: \fBXXX\fR dir \fBname\fR: not a directory
(error) \fBAmcheck\fR expected \fBname\fR to be a directory, but it is something else (e\&.g\&. file)\&.

.TP
WARNING: info file \fIfile\fR: does not exist
(warning) File \fBfile\fR does not exist in the text format database\&. Since the parent directories do exist, the file should already have been created\&.

.TP
ERROR: info file \fIname\fR: not a file
(error) \fBAmcheck\fR expected \fBname\fR to be a file, but it is something else (e\&.g\&. file)\&.

.TP
ERROR: info file \fIfile\fR: not readable
(error) The text format database file \fBfile\fR is not readable\&.

.TP
ERROR: log file \fIfile\fR: not writable
(error) Log file \fBfile\fR (file \fBlog\fR in \fBlogdir\fR from \fBamanda\&.conf\fR) is either not writable, or cannot be accessed, perhaps because a parent directory does not allow search permission\&.

.TP
ERROR: tape list \fBtapelist\fR: not writable
(error) \fBAMANDA\fR tape list file \fBtapelist\fR (see \fBtapelist\fR in \fBamanda\&.conf\fR) is not writable or was not found\&.

.TP
ERROR: tape list \fBtapelist\fR: parse error
(error) \fBAMANDA\fR tape list file \fBtapelist\fR (see \fBtapelist\fR in \fBamanda\&.conf\fR) could not be read or parsed\&.

.TP
WARNING: tapedev is /dev/null, dumps will be thrown away
(warning) The \fBtapedev\fR parameter in \fBamanda\&.conf\fR is set to \fI/dev/null\fR and \fBAMANDA\fR uses that when debugging to throw all the dump images away\&.

.TP
WARNING: hold file \fIfile\fR exists
(info) Hold file \fBfile\fR exists and will cause \fBamdump\fR to pause at the beginning until it is removed\&.

.TP
ERROR: holding disk \fBdisk\fR: statfs: \fBerror message\fR
(error) An error was returned from the \fBstatfs\fR system call on holding disk \fBdisk\fR (maybe because it does not exist)\&.

.TP
ERROR: holding disk \fBdisk\fR: not writable
(error) Holding disk \fBdisk\fR, is not writable, probably because the caller does not have write permission or a parent directory does not allow search permission\&.

.TP
WARNING: holding disk \fBdisk\fR: available space unknown \fBN\fR KB requested\&.
(warning) \fBAmcheck\fR could not determine the amount of available space on holding disk \fBdisk\fR to see if there were at least \fBN\fR KBytes available\&.

.TP
WARNING: holding disk \fBdisk\fR: only \fBF\fR KB free (\fBR\fR KB requested)\&.
(warning) \fBamanda\&.conf\fR requested \fBR\fR KBytes of free space on holding disk \fBdisk\fR, but only \fBF\fR KBytes were available\&. 10 MBytes is subtracted for each backup process (see the \fBinparallel\fR  \fBamanda\&.conf\fR option) to allow for unexpected overruns\&.

.RS
.Sh "Note"
Even though this message is listed as a warning, it causes  \fBamcheck\fR to exit with a non\-zero status\&.
.RE

.TP
Holding disk \fBdisk\fR: \fBN\fR KB disk space available, that's plenty\&.
(info) There was sufficient free space on holding disk \fBdisk\fR\&.

.TP
WARNING: holding disk \fBdisk\fR: only \fBF\fR KB free, using nothing
(warning) Holding disk \fBdisk\fR has \fBF\fR KBytes of free space, but that is not enough for what is requested in \fBamanda\&.conf\fR\&.

.TP
Holding disk \fBdisk\fR: \fBF\fR KB disk space available, using \fBU\fR KB
(info) Holding disk \fBdisk\fR has \fBF\fR KBytes of free space and \fBAMANDA\fR will be using up to \fBU\fR Kbytes\&.

.TP
WARNING: if a tape changer is not available, runtapes must be set to 1\&.
(warning) The \fBruntapes\fR  \fBamanda\&.conf\fR option must be set to 1 if the \fBtpchanger\fR  \fBamanda\&.conf\fR option is not set\&.

.TP
ERROR: \fBerror message\fR\&.
(error) An error was detected while initializing the tape changer\&.

.TP
ERROR: \fBtape device\fR: \fBerror message\fR\&.
(error) An error was detected while processing the tape label\&.

.TP
ERROR: cannot overwrite active tape \fBlabel\fR\&.
(error) Tape \fBlabel\fR is still active and cannot be used\&.

.TP
ERROR: label \fBlabel\fR doesn't match labelstr \fBpattern\fR \&.
(error) The label on tape \fBlabel\fR does not match the \fBlabelstr\fR  \fBamanda\&.conf\fR option\&.

.TP
(expecting a new tape)
(info) The tape is not OK and a new tape was expected\&.

.TP
(expecting tape \fBlabel\fR or a new tape)
(info) The tape is not OK and either tape \fBlabel\fR or a new tape was expected\&.

.TP
ERROR: tape \fBlabel\fR label ok, but is not writable\&.
(error) Tape \fBlabel\fR is OK, but the write enable test failed\&.

.TP
Tape \fBlabel\fR is writable\&.
(info) Tape \fBlabel\fR is OK and the write enable test succeeded\&.

.TP
NOTE: skipping tape\-writable test\&.
(info) The tape write test (see the \fB\-w\fR option) was not enabled\&.

.TP
WARNING: skipping tape test because amdump or amflush seem to be running, WARNING: if they are not, you must run amcleanup, 
(warning) It looked to \fBamcheck\fR like either \fBamdump\fR or \fBamflush\fR were running because a log file or amdump file exists\&. If they are not running, you probably need to run \fBamcleanup\fR to clear up a previous failure\&. Otherwise, you need to wait until they complete before running \fBamcheck\fR\&.

.TP
NOTE: skipping tape checks
(info) The tape tests are being skipped because you used the \fB\-t\fR command line option\&.

.TP
WARNING: \fBcompress\fR is not executable, server\-compression and indexing will not work
(warning) Compression program \fBcompress\fR is not executable, so compression on the tape server host and creating index files will not work\&.

.TP
Tape \fBlabel\fR label ok\&.
(info) Tape \fBlabel\fR is OK for the next run\&.

.TP
Server check took \fBS\fR seconds\&.
(info) Reports how long the tape server host checks took\&.

.TP
ERROR: \fBhost\fR: could not resolve hostname
(error) Could not look up client hostname \fBhost\fR\&.

.TP
Client check: \fBH\fR hosts checked in \fBS\fR seconds, \fBN\fR problems found\&.
(info) Reports the number of client hosts checked, how long it took and the number of errors detected\&.

.TP
WARNING: \fBhost\fR: selfcheck request timed out\&. Host down?
(warning) There was no response from \fBhost\fR when trying to do the client checks\&. The host might really be down or it might not be configured properly\&.

.TP
ERROR: \fBhost\fR NAK: \fBmessage\fR
(error) \fBHost\fR reported a negative acknowledgment error of \fBmessage\fR to the status check request\&.

.TP
ERROR: \fBhost\fR NAK: [NAK parse failed]
(error) \fBAmcheck\fR could not parse the negative acknowledgment error from \fBhost\fR\&. There might be an \fBAMANDA\fR version mismatch between the host running \fBamcheck\fR and \fBhost\fR\&.

.TP
ERROR: \fBhost\fR [mutual\-authentication failed]
(error) Kerberos authentication failed while contacting \fBhost\fR\&.

.TP
ERROR: \fBhost\fR: \fBmessage\fR
(error) Error \fBmessage\fR was reported by the status check on \fBhost\fR\&.

.SH "AUTHOR"

.PP
James da Silva, <jds@amanda\&.org> : Original text

.PP
Stefan G\&. Weichinger, <sgw@amanda\&.org>, maintainer of the \fBAMANDA\fR\-documentation: XML\-conversion

.SH "SEE ALSO"

.PP
\fBamanda\fR(8), \fBamdump\fR(8)

